# ğŸ” Practice 5 â€” Secure secrets management with SOPS + Age

ĞŸÑ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ¿Ğ¾ Ğ¸Ğ·ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞµĞºÑ€ĞµÑ‚Ğ°Ğ¼Ğ¸ Ğ² DevOps:
**Age** Ğ¸ **SOPS**.

---

## ğŸ“Œ Ğ¦ĞµĞ»ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹

Ğ¦ĞµĞ»ÑŒÑ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ:
- Ğ¸Ğ·ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ¾Ğ² ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²;
- Ğ¾ÑĞ²Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ° **Age** Ğ´Ğ»Ñ Ğ°ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ;
- Ğ¾ÑĞ²Ğ¾ĞµĞ½Ğ¸Ğµ **SOPS** Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² Ğ² Git;
- ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ° YAML-Ñ„Ğ°Ğ¹Ğ»Ğ° Ñ ÑĞµĞºÑ€ĞµÑ‚Ğ°Ğ¼Ğ¸;
- Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ workflow Ğ±ĞµĞ· Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ñ… ĞºĞ»ÑÑ‡ĞµĞ¹ Ğ² Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸.

---

## ğŸ§  ĞšÑ€Ğ°Ñ‚ĞºĞ°Ñ Ñ‚ĞµĞ¾Ñ€Ğ¸Ñ

### ğŸ”‘ Age
**Age** â€” ÑĞ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‰Ğ¸Ğ¹:
- X25519 (Ğ°ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡Ğ½Ğ¾Ğµ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ);
- ChaCha20-Poly1305 (ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡Ğ½Ğ¾Ğµ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ).

ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» ÑˆĞ¸Ñ„Ñ€ÑƒĞµÑ‚ÑÑ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ĞºĞ»ÑÑ‡Ğ¾Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (envelope encryption), Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ½ĞµĞ¼Ñƒ Ğ¸Ğ¼ĞµÑÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ñ‹ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ñ… ĞºĞ»ÑÑ‡ĞµĞ¹.

### ğŸ— SOPS
**SOPS (Secrets OPerationS)** â€” Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞµĞºÑ€ĞµÑ‚Ğ°Ğ¼Ğ¸ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Age, Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑÑ‰Ğ¸Ğ¹:
- ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ **Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ**, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ YAML;
- Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² Git;
- ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸ ĞºĞ»ÑÑ‡Ğ°.

---

## ğŸ§° Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹

- Linux (Ubuntu, WSL2)
- Age
- SOPS
- Git
- GitHub

---

## ğŸ–¥ Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹:
- Ubuntu 20.04 / 22.04 / 24.04
- Windows Ñ WSL2 (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)

---

## ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```text
practice5.sops-demo
â”œâ”€â”€ .sops.yaml
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ screenshots
â”‚   â”œâ”€â”€ age-version.png
â”‚   â”œâ”€â”€ sops-version.png
â”‚   â”œâ”€â”€ encrypt-postgres.png
â”‚   â”œâ”€â”€ encrypted-file.png
â”‚   â””â”€â”€ decrypt-postgres.png
â””â”€â”€ secrets
    â””â”€â”€ database
        â””â”€â”€ postgres.enc.yaml
```

## âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° SOPS
Ğ¤Ğ°Ğ¹Ğ» .sops.yaml Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:
creation_rules:
  - path_regex: 'secrets/database/.*\.enc\.yaml$'
    age: 'age1XXXXXXXXXXXXXX'

sops_version: 3.8.1


## ğŸ” ĞŸÑ€Ğ¾Ñ†ĞµÑÑ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ»ÑÑ‡ĞµĞ¹ Age:
```
age-keygen -o keys.txt
```

ĞŸÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾:
```
~/.config/sops/age/keys.txt
```

Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ YAML-Ñ„Ğ°Ğ¹Ğ»Ğ°:
```
sops --encrypt secrets/database/postgres.yaml > secrets/database/postgres.enc.yaml
```

## ğŸ”“ ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ¸
```
sops --decrypt secrets/database/postgres.enc.yaml
```
