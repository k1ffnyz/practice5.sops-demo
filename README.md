# üîê Practice 5 ‚Äî Secure secrets management with SOPS + Age

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ –∏–∑—É—á–µ–Ω–∏—é –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –≤ DevOps:
**Age** –∏ **SOPS**.

---

## üìå –¶–µ–ª—å —Ä–∞–±–æ—Ç—ã

–¶–µ–ª—å—é –¥–∞–Ω–Ω–æ–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã —è–≤–ª—è–µ—Ç—Å—è:
- –∏–∑—É—á–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤;
- –æ—Å–≤–æ–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ **Age** –¥–ª—è –∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–≥–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è;
- –æ—Å–≤–æ–µ–Ω–∏–µ **SOPS** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Git;
- —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ YAML-—Ñ–∞–π–ª–∞ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏;
- –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ workflow –±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

---

## üß† –ö—Ä–∞—Ç–∫–∞—è —Ç–µ–æ—Ä–∏—è

### üîë Age
**Age** ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ñ–∞–π–ª–æ–≤–æ–≥–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π:
- X25519 (–∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ);
- ChaCha20-Poly1305 (—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ).

–ö–∞–∂–¥—ã–π —Ñ–∞–π–ª —à–∏—Ñ—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º –¥–∞–Ω–Ω—ã—Ö (envelope encryption), –∞ –¥–æ—Å—Ç—É–ø –∫ –Ω–µ–º—É –∏–º–µ—é—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—ã –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π.

### üóù SOPS
**SOPS (Secrets OPerationS)** ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –ø–æ–≤–µ—Ä—Ö Age, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π:
- —à–∏—Ñ—Ä–æ–≤–∞—Ç—å **—Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è**, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É YAML;
- –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ Git;
- —É–¥–æ–±–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–ª—é—á–∞.

---

## üß∞ –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

- Linux (Ubuntu, WSL2)
- Age
- SOPS
- Git
- GitHub

---

## üñ• –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–∫—Ä—É–∂–µ–Ω–∏—é

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:
- Ubuntu 20.04 / 22.04 / 24.04
- Windows —Å WSL2 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
practice5.sops-demo
‚îú‚îÄ‚îÄ .sops.yaml
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ screenshots
‚îÇ   ‚îú‚îÄ‚îÄ age-version.png
‚îÇ   ‚îú‚îÄ‚îÄ sops-version.png
‚îÇ   ‚îú‚îÄ‚îÄ encrypt-postgres.png
‚îÇ   ‚îú‚îÄ‚îÄ encrypted-file.png
‚îÇ   ‚îî‚îÄ‚îÄ decrypt-postgres.png
‚îî‚îÄ‚îÄ secrets
    ‚îî‚îÄ‚îÄ database
        ‚îî‚îÄ‚îÄ postgres.enc.yaml
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SOPS
–§–∞–π–ª .sops.yaml –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:
creation_rules:
  - path_regex: 'secrets/database/.*\.enc\.yaml$'
    age: 'age1XXXXXXXXXXXXXX'

sops_version: 3.8.1


## üîê –ü—Ä–æ—Ü–µ—Å—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π Age:
```
age-keygen -o keys.txt
```

–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ:
```
~/.config/sops/age/keys.txt
```

–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ YAML-—Ñ–∞–π–ª–∞:
```
sops --encrypt secrets/database/postgres.yaml > secrets/database/postgres.enc.yaml
```

## üîì –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
```
sops --decrypt secrets/database/postgres.enc.yaml
```

## üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
-  –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –ù–ï —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Git
-  –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
-  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è .gitignore –¥–ª—è –∑–∞—â–∏—Ç—ã –∫–ª—é—á–µ–π


## üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Age
![Age version](screenshots/age-version.png)

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SOPS
![SOPS version](screenshots/sops-version.png)

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
![Encrypt secrets](screenshots/encrypt-postgres.png)

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
![Encrypted file](screenshots/encrypted-file.png)

### –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å–µ–∫—Ä–µ—Ç–∞
![Decrypt secrets](screenshots/decrypt-postgres.png)


## ‚úÖ –ò—Ç–æ–≥
–í —Ö–æ–¥–µ —Ä–∞–±–æ—Ç—ã:
* —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Age;
* —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω SOPS;
* —Å–æ–∑–¥–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è .sops.yaml;
* –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω YAML-—Ñ–∞–π–ª —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏;
* –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞;
* –æ–±–µ—Å–ø–µ—á–µ–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Git.
